---
- name: Create Tailscale state directory
  ansible.builtin.file:
    path: "{{ tailscale_state_dir }}"
    state: directory
    mode: "0700"

- name: Create Tailscale Serve config directory
  ansible.builtin.file:
    path: "{{ tailscale_serve_config_dir }}"
    state: directory
    mode: "0755"
  when: tailscale_serve_enabled

- name: Render Tailscale Serve config
  ansible.builtin.template:
    src: "{{ tailscale_serve_config_src }}"
    dest: "{{ tailscale_serve_config_dir }}/serve.json"
    mode: "0644"
  when: tailscale_serve_enabled

- name: Deploy Tailscale sidecar container
  community.docker.docker_container:
    name: "{{ tailscale_container_name }}"
    image: "{{ tailscale_image }}"
    state: started
    restart_policy: always
    networks:
      - name: "{{ tailscale_network_name }}"
    ports: "{{ tailscale_host_ports }}"
    capabilities:
      - NET_ADMIN
      - SYS_MODULE
    env: >-
      {{
        {
          'TS_HOSTNAME': tailscale_hostname,
          'TS_AUTHKEY': tailscale_authkey,
          'TS_STATE_DIR': '/var/lib/tailscale',
          'TS_USERSPACE': 'false',
          'TS_ACCEPT_DNS': 'true',
        }
        | combine(
            {'TS_SERVE_CONFIG': '/etc/tailscale/serve.json'}
            if tailscale_serve_enabled else {}
          )
        | combine(
            {'TS_EXTRA_ARGS': tailscale_extra_args}
            if tailscale_extra_args else {}
          )
      }}
    volumes: >-
      {{
        [
          tailscale_state_dir ~ ':/var/lib/tailscale',
          '/dev/net/tun:/dev/net/tun',
        ]
        + (
            [tailscale_serve_config_dir ~ ':/etc/tailscale:ro']
            if tailscale_serve_enabled else []
          )
      }}

- name: Wait for Tailscale to connect to tailnet
  community.docker.docker_container_exec:
    container: "{{ tailscale_container_name }}"
    command: tailscale status --json
  register: ts_status
  until: (ts_status.stdout | from_json).BackendState == "Running"
  retries: 30
  delay: 2
